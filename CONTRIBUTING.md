< [README](./README.md)

# Contributing to Fresnel

Refer to [API.md](./API.md) for overview of how Fresnel works
internally, as well as function-level documentation.

To contribute, you'll want to install Fresnel directly from the
Git repository, and create a dynamic link for easy use from the
command-line:

```
$ git clone https://gerrit.wikimedia.org/r/performance/fresnel
$ cd fresnel/

fresnel$ npm ci
fresnel$ npm link

# Then, use the 'fresnel' command.
```

For example, if you use [Fresh](https://gerrit.wikimedia.org/g/fresh/)
and want to locally benchmark a change to MediaWiki:

```
you$ cd Dev/
you:Dev$ fresh-node -root -net -env

nobody:Dev$ cd fresnel/
nobody:fresnel$ npm ci && npm link
nobody:fresnel$ fresnel --version
…

nobody:fresnel$ cd ../mediawiki
nobody:mediawiki (master)$ fresnel record before
…

# now, make some changes
…
nobody:mediawiki (my-changes)$ fresnel record after
…
nobody:mediawiki (my-changes)$ fresnel compare before after
…
| Metric    | Before | After | Diff |
…

# you can now repeat:
# * make more changes
# * re-record 'after'
# * compare
```

## Build steps

* `npm test`
  Runs the linter, tests and regenerate the API docs.
  To run a specific test suite only, use `npm run qunit -- path/to/a/test.js`
* `npm run doc`
  Regenerates the API docs.
* `npm run doc:dump`
  Lists the available [JSDoc identifiers](https://github.com/jsdoc2md/jsdoc-to-markdown/wiki/Listing-namepaths) to help with `{@link}` inside comments.

This project is primarily installed as a command-line tool, not as a library.
As such, it maintains an `npm-shrinkwrap.json` file instead of a `package-lock.json` file.
See also <https://docs.npmjs.com/files/package-locks> and <https://docs.npmjs.com/cli/shrinkwrap>.

## Documentation

This project is documented with [JSDoc](http://usejsdoc.org/). [API.md](./API.md) is generated by [jsdoc2md](https://github.com/jsdoc2md/jsdoc-to-markdown/wiki). To locally view the Markdown files in a browser, you could [npm install -g md-fileserver](https://www.npmjs.com/package/md-fileserver) and  run `mdopen API.md`.

## Tests

This project is tested with [QUnit](https://api.qunitjs.com/assert/), using [nyc](https://istanbul.js.org/) for code coverage. The coverage report gets generated as part of the `npm run test` command. The nyc tool is configured in `package.json`. Run `npx nyc help config` to view its option documentation.

View the latest code coverage report at <https://doc.wikimedia.org/cover/fresnel/>. Or, open `coverage/index.html` locally in a browser after running the tests.

## Release

To prepare the release commit, follow these steps:

1. Add a section to `CHANGELOG.md` for this release. Use `npm run changelog` to generate the bullet
   points with changes since the last release.

   Only mention changes that affect the public API, CLI, or program output.
   and use Added/Changed/Deprecated/Removed/Fixed headings accordingly (see [keepachangelog.com](https://keepachangelog.com/en/1.0.0/)).
2. Set the next version in `package.json`.
3. Run `npm install` to ensure the `npm-shrinkwrap.json` file reflects the version change.
   If it contains other changes as well, this means a previous commit forgot to update
   the shrinkwrap when changing dependencies. In that case, commit and review those changes
   first on their own, before preceeding with the release.
4. Stage and commit the changes with message `Release X.Y.Z`,
   and push it for review.
5. Once merged by CI, run `npm publish`.
